$.Redactor=new Array,$.Redactor.opts=new Array,$.Redactor.opts.langs=new Array,tinymce.PluginManager.add("cannedresponses",function(t,e){return t.on("init",function(e){"response"==t.id&&$("form select#cannedResp").change(function(){var e=$(this).closest("form"),n=$(this).val(),i=$(":input[name=id]",e).val();$(this).find("option:first").attr("selected","selected").parent("select");var o="ajax.php/kb/canned-response/"+n+".json";i&&(o="ajax.php/tickets/"+i+"/canned-resp/"+n+".json"),$.ajax({type:"GET",url:o,dataType:"json",cache:!1,success:function(n){n.response&&t.setContent(t.getContent()+n.response);var i=$(".attachments",e);if(n.files&&i.length){var o=i.find(".dropzone").data("dropbox");$.each(n.files,function(t,e){o.addNode(e)})}}}).done(function(){}).fail(function(){})})}),{getMetadata:function(){return{name:"osTicket canned responses",url:"https://github.com/Micke1101/OSTicket-plugin-TinyMCE"}}}}),tinymce.PluginManager.add("closeextras",function(t,e){return t.on("init",function(e){t.notificationManager.open=function(){var e=t.notificationManager.open;return function(){return $(t.editorContainer).is(":visible")?e.apply(this,arguments):function(){}}}()}),{getMetadata:function(){return{name:"osTicket prevent extra notifications",url:"https://github.com/Micke1101/OSTicket-plugin-TinyMCE"}}}}),tinymce.PluginManager.add("embedvideo",function(t,e){var n=/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w\-\s])([\w\-]{11})(?=[^\w\-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/gi,i=/https?:\/\/(www\.)?vimeo.com\/(\d+)($|\/)/;return t.on("PastePreProcess",function(t){var e='" frameborder="0" allowfullscreen></iframe>';t.content.match(n)?t.content=t.content.replace(n,'<iframe src="//www.youtube.com/embed/$1'+e):t.content.match(i)&&(t.content=t.content.replace(i,'<iframe src="//player.vimeo.com/video/$2'+e))}),{getMetadata:function(){return{name:"osTicket embed video",url:"https://github.com/Micke1101/OSTicket-plugin-TinyMCE"}}}}),tinymce.PluginManager.add("autolock",function(t,e){return $(t.getElement()).closest("form").find("[name=lockCode]").length&&t.on("keydown",function(e){$(t.getElement().closest("[data-lock-object-id]")).exclusive("acquire")}),{getMetadata:function(){return{name:"osTicket autolock",url:"https://github.com/Micke1101/OSTicket-plugin-TinyMCE"}}}}),tinymce.PluginManager.add("signature",function(t,e){function n(n){var o=$($(t.getElement()).get(0));if(selected=$(":input:checked[name="+o.data("signatureField")+"]",o.closest("form")).val(),type=$(n.target).val(),dept=$(":input[name="+o.data("deptField")+"]",o.closest("form")).val(),e="ajax.php/content/signature/",inner=$(".inner",this.$signatureBox),n.preventDefault&&n.preventDefault(),"dept"==selected&&o.data("deptId"))e+="dept/"+o.data("deptId");else if("dept"==selected&&o.data("deptField")){if(!dept)return inner.empty().parent().hide();e+="dept/"+dept}else if("theirs"==selected&&o.data("posterId"))e+="agent/"+o.data("posterId");else{if("none"==type)return i=inner.html(),inner.empty().parent().hide();e+=selected}inner.load(e,function(){i=inner.html()}).parent().show()}var i="";return t.on("init",function(e){var i=$($(t.getElement()).get(0)),o=$('<div class="inner"></div>');if(i.data("signatureField")){$signatureBox=$('<div class="selected-signature"></div>').append(o).appendTo(t.editorContainer),i.data("signature")?o.html(i.data("signature")):$signatureBox.hide(),$("input[name="+i.data("signatureField")+"]",i.closest("form")).on("change",!1,!1,$.proxy(n,this)),i.data("deptField")&&$(":input[name="+i.data("deptField")+"]",i.closest("form")).on("change",!1,!1,$.proxy(n,this));var a=$signatureBox,o=$(".inner",$signatureBox).get(0),c=a.height(),s=void 0,r=$signatureBox.css("box-shadow");$signatureBox.hover(function(){s=setTimeout($.proxy(function(){c=Math.max(c,a.height()),$(this).animate({height:o.offsetHeight},"fast"),$(this).css("box-shadow","none","important")},this),250)},function(){clearTimeout(s),$(this).stop().animate({height:Math.min(o.offsetHeight,c)},"fast"),$(this).css("box-shadow",r)})}}),t.on("SaveContent",function(t){t.content=t.content+i}),{getMetadata:function(){return{name:"osTicket signature",url:"https://github.com/Micke1101/OSTicket-plugin-TinyMCE"}}}}),tinymce.PluginManager.add("contexttypeahead",function(t,e){function n(e){var n,s=t.selection.getRng().commonAncestorContainer.data,r=t.selection.getRng().endOffset,d=s?s.substring(0,r):"",l=new RegExp(/%\{([^}]*)$/);if(!d)return!e.isDefaultPrevented();if(27==e.which||!(n=l.exec(d)))return a();if("click"!=e.type){var u=t.selection,h=u.getRng().getClientRects()[0],p=t.contentWindow.frameElement.getClientRects()[0],f=n[1],g=u.getNode().parentElement||this.editor,m=this;if(this.typeahead||(this.typeahead=$('<input type="text">').css({position:"absolute",visibility:"hidden"}).width(0).height(h.height-4).appendTo(document.body).typeahead({property:"variable",minLength:0,arrow:$('<span class="pull-right"><i class="icon-muted icon-chevron-right"></i></span>').css("padding","0 0 0 6px"),highlighter:function(t,e){var n=$.fn.typeahead.Constructor.prototype.highlighter.call(this,t),i=new RegExp(t+"\\."),o=Object.keys(m.variables).some(function(t){return t.match(i)})?this.options.arrow.clone():"";return $("<div/>").html(n).prepend(o).html()+$('<span class="faded">').text(" â€” "+e.desc).wrap("<div>").parent().html()},item:'<li><a href="#" style="display:block"></a></li>',source:i.bind(this),sorter:function(t){return t.sort(function(t,e){return t.variable>e.variable?1:-1}),t},matcher:function(t){return 0===t.toLowerCase().indexOf(this.query.toLowerCase())&&(this.query.match(/\./g)||[]).length==(t.match(/\./g)||[]).length},onselect:c.bind(this),scroll:!0,items:100})),h){var y=o(f,t.selection.getNode().parentElement||$('<div class="redactor-editor">')),v=$(g).offset().left,x=p.left+h.left-y;x<v&&(x+=v),m.typeahead.css({top:p.top+h.top+$(window).scrollTop(),left:x})}return m.typeahead.val(f).trigger(e),!e.isDefaultPrevented()}}function i(e,n){var i,o=this,a=t.getElement().dataset.rootContext;this.context||(i=$.Deferred(),$.ajax("ajax.php/content/context",{data:{root:a},success:function(t){var e=$.map(t,function(t,e){return{variable:e,desc:t}});o.variables=t,i.resolve(e)}}),this.context=i),this.context.then(function(t){e.process(t)})}function o(t,e){var n=$(e),i=n.clone().text(t).css({position:"absolute",float:"left","white-space":"nowrap",visibility:"hidden"}).css({"font-family":n.css("font-family"),"font-weight":n.css("font-weight"),"font-size":n.css("font-size")}).appendTo($("body")),o=i.width();return i.remove(),o}function a(){this.typeahead&&(this.typeahead.typeahead("hide"),this.typeahead.remove(),this.typeahead=!1)}function c(e,n){t.getDoc().body.normalize();var i=t.selection.getRng().commonAncestorContainer,o=t.selection.getRng(),c=t.selection.getRng().endOffset,s=new RegExp(/%\{([^}]*)(\}?)$/);if(i){var r,d=i.textContent.substring(0,c),l=i.textContent.substring(c),u="I"==n.target.nodeName,h=e.variable+(u?".":"");return d.match(s)&&(r=d.replace(s,"%{"+h+"}"),i.textContent=r+l.replace(/[^%}]*?[%}]/,"")),o.setStart(i,r.length-1),o.setEnd(i,r.length-1),u?(this.typeahead.val(h),this.typeahead.typeahead("lookup"),!1):a()}}return t.on("click",function(t){n(t)}),t.on("keyup",function(t){n(t)}),t.on("keydown",function(t){n(t)}),{getMetadata:function(){return{name:"osTicket context typeahead",url:"https://github.com/Micke1101/OSTicket-plugin-TinyMCE"}}}}),$(function(){findRichtextBoxes=function(){$(".richtext").each(function(t,e){$(e).hasClass("ifhtml")?getConfig().then(function(t){t.html_thread&&tiny(e)}):tiny(e)})},cleanupTinyMCEElements=function(){tinymce.remove()},findRichtextBoxes(),$(document).ajaxStop(findRichtextBoxes),$(document).on("pjax:success",findRichtextBoxes),$(document).on("pjax:start",cleanupTinyMCEElements)}),$(document).ready(function(){$(document).off("click.note",".quicknote .action.edit-note"),$(document).off("click.note",".quicknote .action.cancel-edit"),$(document).off("click.note",".quicknote .action.save-note"),$(document).off("click","#new-note"),$(document).on("click.note",".quicknote .action.edit-note",function(){var t=$(this).closest(".quicknote"),e=t.find(".body"),n=$("<textarea>").text(e.html());return t.closest(".dialog, .tip_box").length&&n.addClass("no-bar small"),e.replaceWith(n),$.tiny(n.get(0)),t.find(".action.edit-note").hide(),t.find(".action.save-note").show(),t.find(".action.cancel-edit").show(),$("#new-note-box").hide(),!1}),$(document).on("click.note",".quicknote .action.cancel-edit",function(){var t=$(this).closest(".quicknote"),e=t.find("textarea"),n=$('<div class="body">');return n.load("ajax.php/note/"+t.data("id"),function(){try{tinymce.get(e[0].id).remove()}catch(t){}e.replaceWith(n),t.find(".action.save-note").hide(),t.find(".action.cancel-edit").hide(),t.find(".action.edit-note").show(),$("#new-note-box").show()}),!1}),$(document).on("click.note",".quicknote .action.save-note",function(){var t=$(this).closest(".quicknote"),e=t.find("textarea");return $.post("ajax.php/note/"+t.data("id"),{note:tinymce.get(e[0].id).getContent()},function(n){var i=$('<div class="body">').html(n);try{tinymce.get(e[0].id).remove()}catch(t){}e.replaceWith(i),t.find(".action.save-note").hide(),t.find(".action.cancel-edit").hide(),t.find(".action.edit-note").show(),$("#new-note-box").show()},"html"),!1}),$(document).on("click","#new-note",function(){var t=$(this).closest(".quicknote"),e=$("<textarea>"),n=$('<input type="button">').val(__("Create"));return n.click(function(){$.post("ajax.php/"+t.data("url"),{note:tinymce.get(e[0].id).getContent(),no_options:t.hasClass("no-options")},function(n){tinymce.get(e[0].id).remove(),e.replaceWith(t),$(n).show("highlight").insertBefore(t.parent()),$(".submit",t.parent()).remove()},"html")}),t.closest(".dialog, .tip_box").length&&e.addClass("no-bar small"),t.replaceWith(e),$("<p>").addClass("submit").css("text-align","center").append(n).appendTo(e.parent()),$.tiny(e.get(0)),!1})}),$(document).ajaxError(function(t,e,n){$.sysAlert(__("Ajax error."),__("An ajax error occured."))});